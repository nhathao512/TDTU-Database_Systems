CREATE DATABASE QLTV;
CREATE TABLE SACH
(
	MS VARCHAR(10) CONSTRAINT PK_MS PRIMARY KEY,
	TEN NVARCHAR(30),
	NSB NVARCHAR(30),
	TG NVARCHAR(30),
	SOLUONG INT,
)

CREATE TABLE DOCGIA
(
	MADG VARCHAR(10) CONSTRAINT PK_MADG PRIMARY KEY,
	TENDG NVARCHAR(30),
	NGAYDK DATE,
	SDT varchar(10)
)

CREATE TABLE PHIEUMUON
(
	MADG VARCHAR(10),
	MS VARCHAR(10),
	NGAYMUON DATE,
	PRIMARY KEY (MADG, MS, NGAYMUON),
	NGAYTRA DATE
)
--1
INSERT INTO SACH VALUES ('M1', 'Lap Trinh Huong Doi Tuong', N'TDTU', N'Tran Thanh Phuoc', 10)
INSERT INTO SACH VALUES ('M2', 'Dai So Tuuyen Tinh', N'TDTU', N'Cao Xuan Phuong', 20)
INSERT INTO SACH VALUES ('M3', 'To Chuc May Tinh', N'TDTU', N'Truong Dinh Tu', 15)
INSERT INTO SACH VALUES ('M4', 'Phuong Phap Lap Trinh', N'TDTU', N'Dung Cam Quang', 5)
INSERT INTO SACH VALUES ('M5', 'Phap Luat Dai Cuong', N'TDTU', N'Nguyen Trung Duong', 50)

INSERT INTO DOCGIA VALUES ('S1', N'Vo Nhat Hao', '1/1/2017', '0334732122')
INSERT INTO DOCGIA VALUES ('S2', N'Vo Nhat Tan', '1/1/2017', '0335736672')
INSERT INTO DOCGIA VALUES ('S3', N'Nguyen Nhat Hao', '1/1/2017', '0332332198')
INSERT INTO DOCGIA VALUES ('S4', N'Tran Nhat Hao', '1/1/2017', '0334738679')
INSERT INTO DOCGIA VALUES ('S5', N'Vo Nhat Tinh', '1/1/2017', '0345093853')

INSERT INTO PHIEUMUON VALUES ('S1', 'M2', '1/1/2023', '3/1/2023')
INSERT INTO PHIEUMUON VALUES ('S1', 'M4', '6/7/2023', '9/10/2023')
INSERT INTO PHIEUMUON VALUES ('S3', 'M1', '2/3/2023', '4/5/2023')
INSERT INTO PHIEUMUON VALUES ('S4', 'M5', '1/1/2023', '3/1/2024')
INSERT INTO PHIEUMUON VALUES ('S5', 'M3', '1/3/2023', '12/11/2025')

SELECT * FROM SACH
SELECT * FROM DOCGIA
SElECT * FROM PHIEUMUON

--2
SELECT COUNT(*) FROM SACH

--3 
SELECT MS, TEN FROM SACH WHERE TEN like 'Lap Trinh%'

--4 
SELECT * FROM SACH WHERE MS in 
(SELECT MS FROM PHIEUMUON WHERE NGAYMUON = NGAYTRA)

--5
SELECT NSB, SUM(SOLUONG) AS SoLuongSach FROM SACH 
GROUP BY NSB ORDER BY SoLuongSach DESC

--6 
SELECT TG, SUM(SOLUONG) AS SoLuongSach FROM SACH 
GROUP BY TG ORDER BY SoLuongSach DESC

--7
SELECT * FROM DOCGIA WHERE MADG in 
(SELECT MADG FROM PHIEUMUON WHERE NGAYDK = GETDATE())

--8 
SELECT * FROM DOCGIA WHERE MADG in 
(SELECT MADG FROM PHIEUMUON WHERE DATEDIFF (DAY, NGAYMUON, NGAYTRA) <= 10)

--9 
SELECT MADG FROM PHIEUMUON
WHERE DATEDIFF(Day, NGAYMUON, NGAYTRA) > 10
GROUP BY MADG
HAVING COUNT(*) >= 3;
 
--10
SELECT * FROM SACH WHERE MS not in 
(SELECT DISTINCT MS FROM PHIEUMUON)

--11
SELECT MADG, COUNT(*) AS SoLanMuon
FROM PHIEUMUON where year(NGAYMUON) = 2008
GROUP BY MADG
ORDER BY SoLanMuon DESC;

--12 
INSERT INTO SACH VALUES ('M6','Toan ',N'TDTU', N'Nguyen Thi Hoa',35)

--13 
INSERT INTO SACH VALUES ('M7','Tieng Anh',N'Lao dong', N'Kim Dong',7)
UPDATE SACH SET SOLUONG = 5 WHERE NSB like '%Lao dong%'

--14
DELETE FROM SACH 
WHERE TG like '%nqt%' 

--15 
DELETE FROM DOCGIA 
WHERE year(getDate()) - year(NGAYDK) > 4

--1
CREATE VIEW VCau3_1 AS
SELECT TG FROM SACH WHERE TG LIKE '%Phuoc'
SELECT * FROM VCau3_1

--2
CREATE VIEW VCAU3_2 AS
SELECT * FROM DOCGIA WHERE SDT IS NULL
SELECT * FROM VCau3_2

--3
CREATE VIEW VCau3_3 AS
SELECT MS, COUNT(*) FROM SACH 
GROUP BY MS
HAVING COUNT(*) >= 3
SELECT * FROM VCau3_3
--4
CREATE VIEW VCau3_4 AS
SELECT SACH.MS, COUNT(*) AS SoLanMuon
FROM SACH
INNER JOIN PHIEUMUON ON SACH.MS = PHIEUMUON.MS
GROUP BY SACH.MS
ORDER BY SoLanMuon DESC
SELECT * FROM VCau3_4

--5
CREATE VIEW VCau3_5 AS
SELECT MADG, TENDG FROM DOCGIA 
WHERE year(getDate()) - year(NGAYDK) > 4
SELECT * FROM VCau3_5

--6
CREATE VIEW VCau3_6 AS
SELECT MS, TEN FROM SACH
WHERE SOLUONG IN 
(SELECT MAX(SOLUONG) FROM SACH)
SELECT * FROM VCau3_6

--8
CREATE VIEW VCau3_8 AS
SELECT SACH.MS, COUNT(*) AS SoLanMuon
FROM SACH
INNER JOIN PHIEUMUON ON SACH.MS = PHIEUMUON.MS
GROUP BY SACH.MS
HAVING COUNT(*) > 10


